<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navikko TOTP Sync Test - Speakeasy</title>
    <script src="https://cdn.jsdelivr.net/npm/speakeasy@2.0.0/lib/speakeasy.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .secret {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .code {
            font-size: 24px;
            font-weight: bold;
            font-family: monospace;
            text-align: center;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Navikko TOTP Sync Test - Speakeasy Implementation</h1>
        <p>This test verifies that the new speakeasy-based TOTP implementation works correctly and synchronizes with authenticator apps.</p>

        <div class="test-section">
            <h2>Test 1: Generate TOTP Secret</h2>
            <button onclick="generateSecret()">Generate New Secret</button>
            <div id="secret-display" class="secret"></div>
            <div id="qr-url" class="info"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Generate Current TOTP Code</h2>
            <button onclick="generateCurrentCode()">Generate Current Code</button>
            <div id="current-code" class="code"></div>
            <div id="remaining-time" class="info"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Verify TOTP Code</h2>
            <input type="text" id="test-code" placeholder="Enter 6-digit code" maxlength="6">
            <button onclick="verifyCode()">Verify Code</button>
            <div id="verification-result"></div>
        </div>

        <div class="test-section">
            <h2>Test 4: Time Synchronization</h2>
            <button onclick="checkTimeSync()">Check Time Sync</button>
            <div id="time-sync-result"></div>
        </div>

        <div class="test-section">
            <h2>Test 5: Multiple Time Windows</h2>
            <button onclick="testTimeWindows()">Test Time Windows</button>
            <div id="time-windows-result"></div>
        </div>
    </div>

    <script>
        let currentSecret = '';

        function generateSecret() {
            try {
                // Generate a new secret using speakeasy
                const secret = speakeasy.generateSecret({
                    name: 'Navikko Admin',
                    issuer: 'Navikko',
                    length: 32
                });

                currentSecret = secret.base32;
                
                // Generate QR code URL
                const qrUrl = speakeasy.otpauthURL({
                    secret: currentSecret,
                    label: 'wasando.tsuyukusa@gmail.com',
                    issuer: 'Navikko Admin',
                    algorithm: 'sha1',
                    digits: 6,
                    period: 30
                });

                document.getElementById('secret-display').innerHTML = `
                    <strong>Generated Secret:</strong> ${currentSecret}<br>
                    <strong>Length:</strong> ${currentSecret.length} characters<br>
                    <strong>Format:</strong> Base32
                `;
                
                document.getElementById('qr-url').innerHTML = `
                    <strong>QR Code URL:</strong><br>
                    <code style="word-break: break-all;">${qrUrl}</code>
                `;

                console.log('‚úÖ Secret generated successfully:', currentSecret);
                console.log('‚úÖ QR URL generated:', qrUrl);
            } catch (error) {
                console.error('‚ùå Error generating secret:', error);
                document.getElementById('secret-display').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        function generateCurrentCode() {
            if (!currentSecret) {
                alert('Please generate a secret first');
                return;
            }

            try {
                const code = speakeasy.totp({
                    secret: currentSecret,
                    encoding: 'base32',
                    digits: 6,
                    period: 30,
                    algorithm: 'sha1'
                });

                const now = Math.floor(Date.now() / 1000);
                const period = 30;
                const remaining = period - (now % period);

                document.getElementById('current-code').textContent = code;
                document.getElementById('remaining-time').innerHTML = `
                    <strong>Remaining time:</strong> ${remaining} seconds<br>
                    <strong>Current timestamp:</strong> ${now}<br>
                    <strong>Counter:</strong> ${Math.floor(now / period)}
                `;

                console.log('‚úÖ Current code generated:', code);
                console.log('‚úÖ Remaining time:', remaining, 'seconds');
            } catch (error) {
                console.error('‚ùå Error generating code:', error);
                document.getElementById('current-code').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        function verifyCode() {
            if (!currentSecret) {
                alert('Please generate a secret first');
                return;
            }

            const testCode = document.getElementById('test-code').value;
            if (!testCode || testCode.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            try {
                const isValid = speakeasy.totp.verify({
                    secret: currentSecret,
                    encoding: 'base32',
                    token: testCode,
                    window: 1,
                    digits: 6,
                    period: 30,
                    algorithm: 'sha1'
                });

                const result = document.getElementById('verification-result');
                if (isValid) {
                    result.innerHTML = `<span class="success">‚úÖ Code ${testCode} is VALID!</span>`;
                } else {
                    // Generate expected code for comparison
                    const expectedCode = speakeasy.totp({
                        secret: currentSecret,
                        encoding: 'base32',
                        digits: 6,
                        period: 30,
                        algorithm: 'sha1'
                    });
                    
                    result.innerHTML = `
                        <span class="error">‚ùå Code ${testCode} is INVALID</span><br>
                        <span class="info">Expected current code: ${expectedCode}</span>
                    `;
                }

                console.log('‚úÖ Code verification completed. Valid:', isValid);
            } catch (error) {
                console.error('‚ùå Error verifying code:', error);
                document.getElementById('verification-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        function checkTimeSync() {
            if (!currentSecret) {
                alert('Please generate a secret first');
                return;
            }

            try {
                const now = Date.now();
                const serverTime = Math.floor(now / 1000);
                const localTime = Math.floor(now / 1000);
                
                const result = document.getElementById('time-sync-result');
                result.innerHTML = `
                    <div class="info">
                        <strong>Time Synchronization Check:</strong><br>
                        Server time: ${serverTime}<br>
                        Local time: ${localTime}<br>
                        Difference: ${Math.abs(serverTime - localTime)} seconds<br>
                        Status: ${Math.abs(serverTime - localTime) < 5 ? '‚úÖ Synchronized' : '‚ö†Ô∏è May have drift'}
                    </div>
                `;

                console.log('‚úÖ Time sync check completed');
            } catch (error) {
                console.error('‚ùå Error checking time sync:', error);
                document.getElementById('time-sync-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        function testTimeWindows() {
            if (!currentSecret) {
                alert('Please generate a secret first');
                return;
            }

            try {
                const now = Math.floor(Date.now() / 1000);
                const period = 30;
                const currentCounter = Math.floor(now / period);
                
                let result = '<div class="info"><strong>Time Windows Test:</strong><br>';
                
                // Test codes for current, previous, and next windows
                for (let i = -1; i <= 1; i++) {
                    const counter = currentCounter + i;
                    const code = speakeasy.totp({
                        secret: currentSecret,
                        encoding: 'base32',
                        digits: 6,
                        period: 30,
                        algorithm: 'sha1',
                        counter: counter
                    });
                    
                    const windowName = i === -1 ? 'Previous' : i === 0 ? 'Current' : 'Next';
                    result += `${windowName} window (counter ${counter}): ${code}<br>`;
                }
                
                result += '</div>';
                document.getElementById('time-windows-result').innerHTML = result;

                console.log('‚úÖ Time windows test completed');
            } catch (error) {
                console.error('‚ùå Error testing time windows:', error);
                document.getElementById('time-windows-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        // Auto-generate a secret on page load
        window.onload = function() {
            generateSecret();
        };
    </script>
</body>
</html> 