<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple 2FA Setup - Navikko Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .secret-section {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .secret-code {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            word-break: break-all;
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #1976d2;
        }
        .current-code {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .countdown {
            font-size: 16px;
            color: #666;
        }
        .instructions {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background-color: #ffebee;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        .success {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background-color: #1565c0;
        }
        .debug-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .qr-url {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Simple 2FA Setup - Navikko Admin</h1>
            <p>Generate a new TOTP secret with corrected algorithm</p>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è Important</h3>
            <p>This will generate a completely new 2FA secret. You'll need to remove the old Navikko entry from Google Authenticator and add this new one.</p>
        </div>

        <button onclick="generateFresh2FA()">üîÑ Generate Fresh 2FA Secret</button>

        <div id="setupSection" style="display: none;">
            <div class="secret-section">
                <h3>üì± New TOTP Secret</h3>
                <div class="secret-code" id="secretDisplay"></div>
                <p><strong>Account:</strong> admin@navikko.com</p>
                <p><strong>Issuer:</strong> Navikko</p>
            </div>

            <div class="instructions">
                <h3>üìã Manual Setup Instructions</h3>
                <ol>
                    <li><strong>Remove old entry:</strong> Delete any existing "Navikko" entry from Google Authenticator</li>
                    <li><strong>Add new entry manually:</strong> 
                        <ul>
                            <li>Open Google Authenticator</li>
                            <li>Tap the "+" button</li>
                            <li>Select "Enter a setup key"</li>
                            <li>Account name: <strong>admin@navikko.com</strong></li>
                            <li>Your key: <strong>Copy the secret above</strong></li>
                            <li>Type of key: <strong>Time based</strong></li>
                        </ul>
                    </li>
                    <li><strong>Verify setup:</strong> Check that the current code matches below</li>
                    <li><strong>Update database:</strong> Copy the SQL command to update the database</li>
                    <li><strong>Test login:</strong> Try logging in with the new code</li>
                </ol>
            </div>

            <div class="secret-section">
                <h3>üïê Current TOTP Code</h3>
                <div class="current-code" id="currentCode">------</div>
                <div class="countdown" id="countdown">--</div>
                <p>This should match your Google Authenticator</p>
            </div>

            <div class="success">
                <h3>üíæ Database Update SQL</h3>
                <p>Run this SQL command to update the database with the new secret:</p>
                <div class="secret-code" id="sqlCommand"></div>
                <button onclick="copySQLCommand()">üìã Copy SQL Command</button>
            </div>

            <div class="success">
                <h3>üîó QR Code URL (Optional)</h3>
                <p>You can also use this URL to generate a QR code externally:</p>
                <div class="qr-url" id="qrUrl"></div>
                <button onclick="copyQRUrl()">üìã Copy QR URL</button>
            </div>

            <div class="debug-info">
                <h4>üîç Debug Information</h4>
                <div id="debugInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // TOTP Service with corrected endianness handling and time synchronization
        // Time synchronization configuration
        const TIME_SYNC_CONFIG = {
            // Compensate for 8-second clock drift (app is 8 seconds faster)
            CLOCK_DRIFT_COMPENSATION: -8, // seconds to subtract from current time
            ENABLE_TIME_SYNC: true
        };

        class TOTPService {
            constructor(config = {}) {
                this.config = {
                    secret: config.secret || this.generateSecret(),
                    digits: config.digits || 6,
                    period: config.period || 30,
                    algorithm: config.algorithm || 'SHA1'
                };
            }

            generateSecret() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                let secret = '';
                for (let i = 0; i < 32; i++) {
                    secret += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return secret;
            }

            base32ToBytes(base32) {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
                const bytes = [];
                let bits = 0;
                let value = 0;

                for (let i = 0; i < base32.length; i++) {
                    const char = base32[i].toUpperCase();
                    const index = alphabet.indexOf(char);
                    if (index === -1) continue;

                    value = (value << 5) | index;
                    bits += 5;

                    if (bits >= 8) {
                        bytes.push((value >>> (bits - 8)) & 0xFF);
                        bits -= 8;
                    }
                }

                return new Uint8Array(bytes);
            }

            async generateCode() {
                const now = this.getSynchronizedTime();
                const counter = Math.floor(now / this.config.period);
                return this.generateCodeForCounter(counter);
            }

            // Get synchronized time accounting for clock drift
            getSynchronizedTime() {
                const currentTime = Math.floor(Date.now() / 1000);
                if (TIME_SYNC_CONFIG.ENABLE_TIME_SYNC) {
                    return currentTime + TIME_SYNC_CONFIG.CLOCK_DRIFT_COMPENSATION;
                }
                return currentTime;
            }

            async generateCodeForCounter(counter) {
                // Convert counter to 8-byte buffer (big-endian)
                const buffer = new ArrayBuffer(8);
                const view = new DataView(buffer);
                view.setBigUint64(0, BigInt(counter), false); // false = big-endian

                // Convert secret to bytes
                const secretBytes = this.base32ToBytes(this.config.secret);

                // Generate HMAC-SHA1
                const key = await crypto.subtle.importKey(
                    'raw',
                    secretBytes,
                    { name: 'HMAC', hash: 'SHA-1' },
                    false,
                    ['sign']
                );

                const signature = await crypto.subtle.sign('HMAC', key, buffer);
                const hash = new Uint8Array(signature);

                // Generate 6-digit code using RFC 6238 standard with corrected endianness
                const offset = hash[hash.length - 1] & 0xf;
                
                if (offset + 3 >= hash.length) {
                    throw new Error('Invalid hash length for TOTP generation');
                }
                
                // FIXED: Use DataView for consistent big-endian byte order
                const codeBuffer = new ArrayBuffer(4);
                const codeView = new DataView(codeBuffer);
                codeView.setUint8(0, hash[offset]);
                codeView.setUint8(1, hash[offset + 1]);
                codeView.setUint8(2, hash[offset + 2]);
                codeView.setUint8(3, hash[offset + 3]);
                const code = codeView.getUint32(0, false); // false = big-endian

                // Apply RFC 6238 mask to clear the high bit
                const maskedCode = code & 0x7fffffff;

                const modulo = Math.pow(10, this.config.digits);
                return (maskedCode % modulo).toString().padStart(this.config.digits, '0');
            }

            generateQRCodeURL(accountName, issuer = 'Navikko') {
                const secret = this.config.secret;
                const url = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(accountName)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}&algorithm=${this.config.algorithm}&digits=${this.config.digits}&period=${this.config.period}`;
                return url;
            }

            getSecret() {
                return this.config.secret;
            }

            getRemainingTime() {
                const now = this.getSynchronizedTime();
                const period = this.config.period;
                return period - (now % period);
            }

            getCurrentCounter() {
                const now = this.getSynchronizedTime();
                return Math.floor(now / this.config.period);
            }

            // Get debug timing information
            getTimingDebugInfo() {
                const rawTime = Math.floor(Date.now() / 1000);
                const synchronizedTime = this.getSynchronizedTime();
                return {
                    rawTime,
                    synchronizedTime,
                    clockDriftCompensation: TIME_SYNC_CONFIG.CLOCK_DRIFT_COMPENSATION,
                    counter: Math.floor(synchronizedTime / this.config.period),
                    remainingTime: this.config.period - (synchronizedTime % this.config.period)
                };
            }
        }

        let totpService;
        let updateInterval;

        async function generateFresh2FA() {
            // Generate new TOTP service with fresh secret
            totpService = new TOTPService();
            
            const secret = totpService.getSecret();
            const qrUrl = totpService.generateQRCodeURL('admin@navikko.com', 'Navikko');
            
            // Display secret
            document.getElementById('secretDisplay').textContent = secret;
            
            // Display QR URL
            document.getElementById('qrUrl').textContent = qrUrl;
            
            // Generate SQL command
            const sqlCommand = `UPDATE admin_access SET two_factor_secret = '${secret}', two_factor_enabled = true WHERE user_id = (SELECT id FROM users WHERE email = 'admin@navikko.com');`;
            document.getElementById('sqlCommand').textContent = sqlCommand;
            
            // Show setup section
            document.getElementById('setupSection').style.display = 'block';
            
            // Start updating current code
            updateCurrentCode();
            updateInterval = setInterval(updateCurrentCode, 1000);
            
            console.log('‚úÖ Fresh 2FA setup generated');
            console.log('Secret:', secret);
            console.log('QR URL:', qrUrl);
        }

        async function updateCurrentCode() {
            if (!totpService) return;
            
            try {
                const code = await totpService.generateCode();
                const remaining = totpService.getRemainingTime();
                const counter = totpService.getCurrentCounter();
                
                document.getElementById('currentCode').textContent = code;
                document.getElementById('countdown').textContent = `Refreshes in ${remaining} seconds`;
                
                // Update debug info with timing details
                const timingInfo = totpService.getTimingDebugInfo();
                const debugInfo = `
Current Time: ${new Date().toISOString()}
Raw Unix Timestamp: ${timingInfo.rawTime}
Synchronized Timestamp: ${timingInfo.synchronizedTime}
Clock Drift Compensation: ${timingInfo.clockDriftCompensation}s
Counter: ${counter}
Current Code: ${code}
Time Remaining: ${remaining}s
Secret: ${totpService.getSecret()}
                `.trim();
                
                document.getElementById('debugInfo').textContent = debugInfo;
                
            } catch (error) {
                console.error('Error generating code:', error);
                document.getElementById('currentCode').textContent = 'ERROR';
            }
        }

        function copySQLCommand() {
            const sqlCommand = document.getElementById('sqlCommand').textContent;
            navigator.clipboard.writeText(sqlCommand).then(() => {
                alert('SQL command copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback: select the text
                const range = document.createRange();
                range.selectNode(document.getElementById('sqlCommand'));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            });
        }

        function copyQRUrl() {
            const qrUrl = document.getElementById('qrUrl').textContent;
            navigator.clipboard.writeText(qrUrl).then(() => {
                alert('QR URL copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback: select the text
                const range = document.createRange();
                range.selectNode(document.getElementById('qrUrl'));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            });
        }

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>